
@{
    ViewBag.Title = "Danh sách hoạt động học thuật trong năm";
    Layout = "~/Views/Shared/_Layout_InternationalCollaboration.cshtml";
}
<style>
    .custom-btn {
        width: 25% !important;
    }

    .modal-title {
        font-size: 1.5rem !important;
    }

    .modal {
        overflow-y: auto;
    }
</style>
<div class="card-body">
    <div class="row mb-5">
        <div class="col-sm-10 col-md-10 col-lg-10 col-xl-10">
            <a href="#" class="btn btn-light-primary px-6 font-weight-bold" data-toggle="modal" data-target="#addModal">Thêm sự kiện</a>
            <div class="dropdown dropdown-inline ml-2">
                <button type="button"
                        class="btn btn-light-primary font-weight-bolder dropdown-toggle"
                        data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false">
                    Export
                </button>
                <div class="dropdown-menu dropdown-menu-sm dropdown-menu-right">
                    <ul class="navi flex-column navi-hover py-2">
                        <li class="navi-header font-weight-bolder text-uppercase font-size-sm text-primary pb-2">
                            Choose an option:
                        </li>
                        <li class="navi-item">
                            <a href="#" class="navi-link">
                                <span class="navi-icon">
                                    <i class="la la-file-excel-o"></i>
                                </span>
                                <span class="navi-text">Excel</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-sm-2 col-md-2 col-lg-2 col-xl-2">
            <div class="input-group date kt_datetimepicker_3_year" id="kt_datetimepicker_3_year" data-target-input="nearest">
                <input type="text" class="form-control datetimepicker-input" data-target="#kt_datetimepicker_3_year" autocomplete="off" id="search_year" onchange="refreshData(this.value)" />
                <div class="input-group-append" data-target="#kt_datetimepicker_3_year" data-toggle="datetimepicker">
                    <span class="input-group-text">
                        <i class="ki ki-calendar"></i>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <table id="my_list" class="table table-bordered table-checkable">
        <thead>
            <tr>
                <th class="text-center">STT</th>
                <th class="text-center">Tiêu đề</th>
                <th class="text-center">Loại</th>
                <th class="text-center">Trạng thái</th>
                <th class="text-center">Hành động</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title font-weight-bolder">Thêm hoạt động học thuật</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i aria-hidden="true" class="ki ki-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group row">
                    <div class="col-md-6 col-xl-6 col-lg-6">
                        <label class="font-weight-bolder">Tiêu đề</label>
                        <input class="form-control" type="text" placeholder="Tiêu đề" autocomplete="off" required id="add_title" />
                    </div>
                    <div class="col-md-6 col-xl-6 col-lg-6">
                        <label class="font-weight-bolder">Loại</label>
                        <select class="form-control" required id="add_category">
                            @foreach (var item in ViewBag.AAType)
                            {
                                <option value="@item.activity_type_id">@item.activity_type_name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3 col-xl-3 col-lg-3">
                        <label class="col-form-label font-weight-bolder">Thời hạn từ </label>
                        <div class="form-group row">
                            <div class="col-lg-12 col-md-9 col-sm-12">
                                <div class="input-group date kt_datetimepicker_3" id="kt_datetimepicker_add_from" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" placeholder="Thời hạn từ" data-target="#kt_datetimepicker_add_from" autocomplete="off" id="add_from" />
                                    <div class="input-group-append" data-target="#kt_datetimepicker_add_from" data-toggle="datetimepicker">
                                        <span class="input-group-text">
                                            <i class="ki ki-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-xl-3 col-lg-3">
                        <label class="col-form-label font-weight-bolder">đến</label>
                        <div class="form-group row">
                            <div class="col-lg-12 col-md-9 col-sm-12">
                                <div class="input-group date kt_datetimepicker_3" id="kt_datetimepicker_add_to" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" placeholder="đến từ" data-target="#kt_datetimepicker_add_to" autocomplete="off" id="add_to" />
                                    <div class="input-group-append" data-target="#kt_datetimepicker_add_to" data-toggle="datetimepicker">
                                        <span class="input-group-text">
                                            <i class="ki ki-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-6 col-lg-6">
                        <label class="col-form-label font-weight-bolder">Địa điểm</label>
                        <input class="form-control" type="text" required autocomplete="off" placeholder="Địa điểm" id="add_location" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary px-6 font-weight-bold" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-light-success px-6 font-weight-bold" data-dismiss="modal" id="btn_add">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title font-weight-bolder">Chỉnh sửa hoạt động học thuật</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i aria-hidden="true" class="ki ki-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group row">
                    <div class="col-md-6 col-xl-6 col-lg-6">
                        <label class="font-weight-bolder">Tiêu đề</label>
                        <input class="form-control" type="text" placeholder="Tiêu đề" autocomplete="off" required id="edit_title" />
                    </div>
                    <div class="col-md-6 col-xl-6 col-lg-6">
                        <label class="font-weight-bolder">Loại</label>
                        <select class="form-control" required id="edit_category">
                            @foreach (var item in ViewBag.AAType)
                            {
                                <option value="@item.activity_type_id">@item.activity_type_name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3 col-xl-3 col-lg-3">
                        <label class="col-form-label font-weight-bolder">Thời hạn từ </label>
                        <div class="form-group row">
                            <div class="col-lg-12 col-md-9 col-sm-12">
                                <div class="input-group date kt_datetimepicker_3" id="kt_datetimepicker_edit_from" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" placeholder="Thời hạn từ" data-target="#kt_datetimepicker_edit_from" autocomplete="off" id="edit_from" />
                                    <div class="input-group-append" data-target="#kt_datetimepicker_edit_from" data-toggle="datetimepicker">
                                        <span class="input-group-text">
                                            <i class="ki ki-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-xl-3 col-lg-3">
                        <label class="col-form-label font-weight-bolder">đến</label>
                        <div class="form-group row">
                            <div class="col-lg-12 col-md-9 col-sm-12">
                                <div class="input-group date kt_datetimepicker_3" id="kt_datetimepicker_edit_to" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" placeholder="đến" data-target="#kt_datetimepicker_edit_to" autocomplete="off" id="edit_to" />
                                    <div class="input-group-append" data-target="#kt_datetimepicker_edit_to" data-toggle="datetimepicker">
                                        <span class="input-group-text">
                                            <i class="ki ki-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-6 col-lg-6">
                        <label class="col-form-label font-weight-bolder">Địa điểm</label>
                        <input class="form-control" type="text" required autocomplete="off" placeholder="Địa điểm" id="edit_location" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary px-6 font-weight-bold" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-light-success px-6 font-weight-bold" data-dismiss="modal" id="btn_edit">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cloneModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title font-weight-bolder">Clone sự kiện</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i aria-hidden="true" class="ki ki-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group row">
                    <div class="col-md-6 col-xl-6 col-lg-6">
                        <label class="font-weight-bolder">Tiêu đề</label>
                        <input class="form-control" type="text" placeholder="Tiêu đề" autocomplete="off" required id="clone_title" />
                    </div>
                    <div class="col-md-6 col-xl-6 col-lg-6">
                        <label class="font-weight-bolder">Loại</label>
                        <select class="form-control" required id="clone_category">
                            @foreach (var item in ViewBag.AAType)
                            {
                                <option value="@item.activity_type_id">@item.activity_type_name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3 col-xl-3 col-lg-3">
                        <label class="col-form-label font-weight-bolder">Thời hạn từ </label>
                        <div class="form-group row">
                            <div class="col-lg-12 col-md-9 col-sm-12">
                                <div class="input-group date kt_datetimepicker_3" id="kt_datetimepicker_clone_from" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" placeholder="Thời hạn từ" data-target="#kt_datetimepicker_clone_from" autocomplete="off" id="clone_from" />
                                    <div class="input-group-append" data-target="#kt_datetimepicker_clone_from" data-toggle="datetimepicker">
                                        <span class="input-group-text">
                                            <i class="ki ki-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-xl-3 col-lg-3">
                        <label class="col-form-label font-weight-bolder">đến</label>
                        <div class="form-group row">
                            <div class="col-lg-12 col-md-9 col-sm-12">
                                <div class="input-group date kt_datetimepicker_3" id="kt_datetimepicker_clone_to" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" placeholder="đến" data-target="#kt_datetimepicker_clone_to" autocomplete="off" id="clone_to" />
                                    <div class="input-group-append" data-target="#kt_datetimepicker_clone_to" data-toggle="datetimepicker">
                                        <span class="input-group-text">
                                            <i class="ki ki-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-6 col-lg-6">
                        <label class="col-form-label font-weight-bolder">Địa điểm</label>
                        <input class="form-control" type="text" required autocomplete="off" placeholder="Địa điểm" id="clone_location" />
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-2 col-form-label font-weight-bolder">Chọn các hạng mục cần sao chép</label>
                    <div class="col-10 col-form-label">
                        <div class="checkbox-list">
                            <label class="checkbox">
                                <input type="checkbox" name="Checkboxes4" value="1" />
                                <span></span>
                                Kinh phí
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" name="Checkboxes4" value="2" />
                                <span></span>
                                Đơn vị đồng tổ chức
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" name="Checkboxes4" value="3" />
                                <span></span>
                                Nội dung
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" name="Checkboxes4" value="4" />
                                <span></span>
                                Đăng kí tham dự
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary px-6 font-weight-bold" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-light-success px-6 font-weight-bold" data-dismiss="modal">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>
        let id_edit = "";
        let id_clone = "";
        let stt = 1;
        document.getElementById('search_year').value = new Date().getFullYear();

        function saveTempIdDelete(id) {
            Swal.fire({
                title: "Bạn có muốn xóa hoạt động học thuật này không ?",
                text: "",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Xác nhận",
                cancelButtonText: "Hủy",
                reverseButtons: true
            }).then(function (result) {
                let object = {
                    id : id
                }
                if (result.value) {
                    $.ajax({
                        url: '/AcademicActivity/delete_AcademicActivity',
                        data: JSON.stringify(object),
                        type: "POST",
                        contentType: "application/json;charset=utf-8",
                        success: function (data) {
                            if (data != '') {
                                toastr.success(data);
                            } else {
                                toastr.error("Có lỗi xảy ra. Vui lòng thử lại");
                            }
                        },
                        error: function (data) {
                            alert(data)
                        }
                    });
                }
            });
        }
        function saveTempIdEdit(id) {
            id_edit = id;
            let obj = {
                id : id
            }
            $.ajax({
                url: "@Url.Action("getBaseAA", "AcademicActivity")",
                data: JSON.stringify(obj),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    document.getElementById('edit_title').value = data.activity_name;
                        document.getElementById('edit_category').value = data.activity_type_id;
                        document.getElementById('edit_from').value = data.from;
                        document.getElementById('edit_to').value = data.to;
                        document.getElementById('edit_location').value = data.location;
                        $('#editModal').modal('show');
                },
                error: function () {
                }
            });
        }
        function saveTempIdCheckin(id) {
            window.location.href = "/CheckIn/List?id=" + id;
        }

        function showCloneModal(id) {
            id_clone = id;
            $('#cloneModal').modal('show');
        }

        function goDetail(id) {
            window.location.href = '/DetailOfAcademicActivity/Index?id=' + id;
        }


        $('#btn_add').click(function () {
            let activity_name = document.getElementById('add_title').value;
            let activity_type_id = document.getElementById('add_category').value;
            let from = document.getElementById('add_from').value;
            let to = document.getElementById('add_to').value;
            let location = document.getElementById('add_location').value;
            if (activity_name == '' || activity_type_id == '' || from == '' || to == '' || location == '') {
                toastr.warning("Bạn chưa điền hết các thông tin cho hoạt động học thuật");
                return false;
            }
            if (from > to) {
                toastr.warning("Thời hạn bắt đầu không thể sau thời hạn kết thúc");
                return false;
            }
            let object = {
                activity_name: activity_name,
                activity_type_id: activity_type_id,
                location: location,
                from: from,
                to: to
            }
            $.ajax({
                url: "@Url.Action("add_AcademicActivity", "AcademicActivity")",
                data: JSON.stringify(object),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    if (data != '') {
                        toastr.success(data);
                        clearModal('#addModal');
                        stt = 1;
                        datatable.ajax.reload();
                    } else {
                        toastr.error("Có lỗi xảy ra. Vui lòng thử lại");
                    }
                },
                error: function (data) {
                    alert(data)
                }
            });
        });

        function clearModal(id) {
            $(id).find('input:text, input:password, select')
                .each(function () {
                    $(this).val('');
                });
        }

        $('#btn_edit').click(function () {
            let activity_name = document.getElementById('edit_title').value;
            let activity_type_id = document.getElementById('edit_category').value;
            let from = document.getElementById('edit_from').value;
            let to = document.getElementById('edit_to').value;
            let location = document.getElementById('edit_location').value;
            if (activity_name == '' || activity_type_id == '' || from == '' || to == '' || location == '') {
                toastr.warning("Bạn chưa điền hết các thông tin cho hoạt động học thuật");
                return false;
            }
            if (from > to) {
                toastr.warning("Thời hạn bắt đầu không thể sau thời hạn kết thúc");
                return false;
            }
            let object = {
                id: id_edit,
                activity_type_id: activity_type_id,
                activity_name: activity_name,
                location: location,
                from: from,
                to: to
            }
            $.ajax({
                url: '/AcademicActivity/edit_AcademicActivity',
                data: JSON.stringify(object),
                type: "POST",
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    if (data != '') {
                        toastr.success(data);
                        clearModal('#editModal');
                        stt = 1;
                        datatable.ajax.reload();
                    } else {
                        toastr.error("Có lỗi xảy ra. Vui lòng thử lại");
                    }
                },
                error: function (data) {
                    alert(data)
                }
            });
        });

        function refreshData(val) {
            alert(val);
        }

        $('#search_year').on('changeDate', function () {
            alert($('#search_year').val());
        });

        var datatable = $("#my_list").DataTable({
                oLanguage: {
                    oPaginate: {
                        sPrevious: "Trang trước",
                        sNext: "Trang sau"
                    },
                    sEmptyTable: "Không có dữ liệu",
                    sInfo: "",
                    sSearch: ""
                },
                "searching": false,
                "lengthChange": false,
                ajax: {
                        url: "@Url.Action("getDatatable", "AcademicActivity")",
                        type: "POST",
                        datatype: "json",
                        data: { "year": function () { return $('#search_year').val() } },
                        cache: "false"
                },
                columns: [
                    {
                        render: function () {
                            return stt++;
                        }
                    },
                    {
                        data: "activity_id_activity_name",
                        render: function (data) {
                            if (data != "") {
                                var id = data.split('$')[0]
                                var name = data.split('$')[1]
                                return '<a href="javascript:;" onclick="goDetail(' + id + ')">' + name + '</a>'
                            } else {
                                return data;
                            }
                        }
                    },
                    {
                        data: "activity_type_name"
                    },
                    {
                        data: "academic_status_name",
                        render: function (data, type, full, meta) {
                            var status = {
                                'Chưa hoạt động': {
                                    'class': 'label-light-warning'
                                },
                                'Đang hoạt động': {
                                    'class': 'label-light-primary'
                                },
                                'Đã kết thúc': {
                                    'class': 'label-light-success'
                                }
                            };
                            if (typeof status[data] === 'undefined') {
                                return data;
                            }
                            return '<span class="label label-lg font-weight-bold ' + status[data].class + ' label-inline">' + data + '</span>';
                        },
                    },
                    {
                        data: "activity_id",
                        render: function (data, type, full, meta) {
                            return '<div class="dropdown">' +
                                '<button class="btn btn-light-primary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Thao tác</button>' +
                                '<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">' +
                                '<a href="javascript:;" class="dropdown-item" onclick="saveTempIdEdit(' + data+')">Sửa</a>' +
                                '<a href="javascript:;" class="dropdown-item" onclick="showCloneModal('+data+')">Clone</a>' +
                                '<a href="javascript:;" class="dropdown-item" target="_tab" onclick="saveTempIdCheckin(' + data+')">Checkin</a>' +
                                '<a href="javascript:;" class="dropdown-item" onclick="saveTempIdDelete(' + data+')">Xóa</a>' +
                                '</div>' +
                                '</div>'
                        }
                    },
                ],
                columnDefs: [
                    {
                        className: "text-center",
                        targets: '_all',
                    },
                ]
            });

        var KTBootstrapDatetimepicker = function () {
            var baseDemos = function () {
                $('.kt_datetimepicker_3').datetimepicker({
                    format: 'DD/MM/YYYY'
                });
            }
            return {
                init: function () {
                    baseDemos();
                }
            };
        }();
        var KTBootstrapDateYeartimepicker = function () {
            var baseDemos = function () {
                $('.kt_datetimepicker_3_year').datetimepicker({
                    format: 'YYYY'
                });
            }
            return {
                init: function () {
                    baseDemos();
                }
            };
        }();
        $(document).ready(function () {
            KTBootstrapDatetimepicker.init();
            KTBootstrapDateYeartimepicker.init();
        });
    </script>
}
