
@{
    ViewBag.Title = "Chi tiết đối tác";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>

    #avata {
        width: 100%;
        height: 100%;
        border: 1px solid black;
    }

    .select2-container {
        float: right;
    }

    .note-editor {
        margin-top: 1.25rem;
    }
</style>

<div class="row justify-content-center" id="card-container">
    <div class="card card-custom col-xl-12 col-lg-12 col-md-12 col-sm-12" id="main-card">
        <div class="card-body p-0 ">
            <div class="row justify-content-center px-8 my-lg-5 px-lg-10">
                <div class="col-xl-12 col-xxl-12">
                    <div class="tabbable-line">
                        <div class="tab-content" id="myTabContent">
                            <div class="row my-4">
                                <div class="col-lg-3 col-md-3 col-sm-3">
                                    <label class="font-weight-bolder">Ảnh đại diện</label>
                                    <div id="image ">
                                        <form id="form1" runat="server">
                                            @{
                                                if (ViewBag.partnerArticle.avatar == null)
                                                {
                                                    <img id="avata" src="~/Content/assets/media/custom-image/Placeholder.jpg" />
                                                }
                                                else
                                                {
                                                    <img id="avata" src="@ViewBag.partnerArticle.avatar" />
                                                }
                                            }
                                            <input class="mt-1" type='file' id="imgInp" />
                                        </form>
                                    </div>
                                </div>
                                <div class="col-lg-9 col-md-9 col-sm-9">
                                    <div class="row justify-content-center mb-5">
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6">
                                            <label class="font-weight-bolder">Tên đối tác</label>
                                            <label style="color:red">*</label>
                                            <label style="font-style: italic;">
                                            </label>
                                            <input value="@ViewBag.partnerArticle.partner_name" class="form-control" type="text" placeholder="Tên đối tác" autocomplete="off" required id="partner_name" />
                                        </div>
                                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6">
                                            <label class="font-weight-bolder">Quốc gia</label>
                                            <label style="color:red">*</label>
                                            <label style="font-style: italic;">
                                            </label>
                                            <select id="partner_nation" class="form-control form-control-lg" required style="width: 100% !important">
                                                <option label="Label"></option>
                                                @{
                                                    foreach (var i in ViewBag.countries)
                                                    {
                                                        <option value="@i.country_id">@i.country_name</option>
                                                    }
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row justify-content-center mb-5">
                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                                            <label class="font-weight-bolder">Lĩnh vực</label>
                                            <label style="color:red">*</label>
                                            <label style="font-style: italic;">
                                            </label>
                                            <textarea id="partner_specialization" placeholder="Lĩnh vực" disabled class="form-control" rows="1"></textarea>
                                        </div>
                                    </div>
                                    <div class="row justify-content-center mb-5">
                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                                            <label class="font-weight-bolder">Website</label>
                                            <label style="font-style: italic;">
                                            </label>
                                            <input value="@ViewBag.partnerArticle.website" class="form-control" type="text" placeholder="Website" autocomplete="off" required id="partner_website" />
                                        </div>
                                    </div>
                                    <div class="row justify-content-center mb-5">
                                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                                            <label class="font-weight-bolder">Địa chỉ</label>
                                            <label style="font-style: italic;">
                                            </label>
                                            <input value="@ViewBag.partnerArticle.address" class="form-control" type="text" placeholder="Địa chỉ" autocomplete="off" required id="partner_address" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-center mb-5">
                                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                                    <label class="font-weight-bolder">Lịch sử hoạt động</label>
                                    <label style="font-style: italic;"></label>
                                    <table class="table table-bordered table-hover table-checkable"
                                           id="partner_acitivity_table">
                                        <thead>
                                            <tr>
                                                <th class="text-center" rowspan="2">STT</th>
                                                <th class="text-center" rowspan="2">Mã</th>
                                                <th class="text-center" rowspan="2">Hoạt động</th>
                                                <th class="text-center" colspan="3">Đại diện</th>
                                                <th class="text-center" rowspan="2">Người thao tác</th>
                                                <th class="text-center" rowspan="2">Thời gian bắt đầu</th>
                                                <th class="text-center" rowspan="2">Thời gian kết thúc</th>
                                            </tr>
                                            <tr>
                                                <th class="text-center">Tên</th>
                                                <th class="text-center">Email</th>
                                                <th class="text-center">SĐT</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="row justify-content-center mb-5">
                                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                                    <label class="font-weight-bolder">Mô tả</label>
                                    <select id="partner_language_type" class="form-control form-control-lg"
                                            required style="width: 20% !important; float: right!important">
                                        <option value="1">Tiếng Việt</option>
                                        <option value="2">English</option>
                                    </select>
                                    <label style="font-style: italic;">
                                    </label>
                                    <div class="summernote mt-4"></div>
                                </div>
                            </div>
                            <div class="row float-right mb-5">
                                <a class="load-btn btn btn-sm btn-secondary font-weight-bold mx-1" href="@Url.Action("List", "Partner")">Quay về</a>
                                <a class="load-btn btn btn-sm btn-light-success font-weight-bold mx-1" id="submit">Cập nhật</a>
                                <a class="load-btn btn btn-sm btn-light-primary font-weight-bold mx-1" id="preview">Xem trước</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script src="~/Content/Custom JS/InternationalCollaboration/Partner/Preview.js"></script>
    <script>

        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    var image = new Image();
                    image.src = e.target.result;
                    image.onload = function () {
                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext("2d");
                        canvas.width = image.width;
                        canvas.height = image.height;
                        ctx.drawImage(image, 0, 0);
                        var URL = canvas.toDataURL('image/jpeg');
                        $('#avata').attr('src', URL);
                    };
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        $("#imgInp").change(function () {
            readURL(this);
        });

        function dataURItoBlob(dataURI) {
            var blobBin = atob(dataURI.split(',')[1]);
            var array = [];
            for (var i = 0; i < blobBin.length; i++) {
                array.push(blobBin.charCodeAt(i));
            }
            var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            var file = new Blob([new Uint8Array(array)], { type: mimeString });
            return file;
        }

        var save_loader = new LoaderBtn($(".load-btn"))
        $('#submit').click(function () {
            var id = @ViewBag.partnerArticle.partner_id;
            var form_data = new FormData();

            var partner_name = $('#partner_name').val()
            var partner_language_type = $('#partner_language_type').val()
            var country_id = $('#partner_nation').val()
            var website = $('#partner_website').val()
            var address = $('#partner_address').val()

            if (partner_name == "") {
                toastr.warning("Vui lòng nhập tên đối tác")
                return;
            }
            if (country_id == "") {
                toastr.warning("Vui lòng chọn quốc gia")
                return;
            }
            var content = $('.summernote').summernote('code') + "";

            var list_image = $('.note-editor').find('img')
            var count_upload = 0;
            if (list_image.length != 0) {
                for (i = 0; i < list_image.length; i++) {
                    var temp = list_image[i];
                    var temp_src = $(temp).attr('src') + "";
                    if (temp_src.includes('data:')) {
                        count_upload++
                        content = content.replace(temp_src, 'image_' + i)
                        form_data.append('image_' + i, dataURItoBlob(temp_src))
                    }
                }
            }
            form_data.append("numberOfImage", count_upload)

            var src = $('#avata').attr('src');
            var template = '/Content/assets/media/custom-image/Placeholder.jpg';
            if (src != template && src.includes('data:image')) {
                form_data.append('image', dataURItoBlob(src))
            }

            form_data.append('partner_id', id)
            form_data.append('partner_name', partner_name)
            form_data.append('partner_language_type', partner_language_type)
            form_data.append('country_id', country_id)
            form_data.append('website', website)
            form_data.append('address', address)
            form_data.append('content', content)

            save_loader.startLoading();
            $.ajax({
                url: "/Partner/Save_Edit",
                method: "post",
                dataType: "json",
                data: form_data,
                processData: false,
                contentType: false,
                success: function (data) {
                    toastr.options = {
                        "closeButton": true,
                        "debug": false,
                        "newestOnTop": false,
                        "progressBar": false,
                        "positionClass": "toast-top-right",
                        "preventDuplicates": false,
                        "showDuration": "300",
                        "hideDuration": "1000",
                        "timeOut": 0,
                        "extendedTimeOut": 0,
                        "showEasing": "swing",
                        "hideEasing": "linear",
                        "showMethod": "fadeIn",
                        "hideMethod": "fadeOut",
                    };
                    if (data.success) {

                        toastr.options.onHidden = function () {
                            window.location.href = '@Url.Action("List", "Partner")';
                        }
                        toastr.clear()
                        toastr.success('Thêm thành công<br />Ấn để quay lại danh sách<br />');
                        save_loader.stopLoading()
                    } else {
                        toastr.clear()
                        toastr.warning(data.content);
                        save_loader.stopLoading()
                    }
                },
                error: function () {
                    toastr.clear();
                    toastr.error('Có lỗi xảy ra khi thêm');
                    save_loader.stopLoading()
                }
            });
        })
    </script>
    <script>
        $('#partner_nation').select2({
            placeholder: 'Quốc gia',
            allowClear: true,
        })
        $('#partner_nation').val('@ViewBag.partnerArticle.country_id').trigger('change')

        $('#partner_language_type').select2({
            placeholder: 'Ngôn ngữ',
        }).on('select2:select', function () {
            $.ajax({
                url: '@Url.Action("LoadContentDetailLanguage", "Partner")',
                type: "POST",
                data:{
                "partner_id": @ViewBag.partnerArticle.partner_id,
                "partner_language_type": $('#partner_language_type').val()
                },
                success: function (data) {
                    $('.summernote').summernote('code', data.content)
                },
                error: function () {

                }
            })
        })

        $('#partner_language_type').val('@ViewBag.partnerArticle.partner_language_type').trigger('change')

        $('#partner_specialization').val('@Html.Raw(ViewBag.specializations_selected)')

        var KTSummernoteDemo = function () {
            // Private functions
            var demos = function () {
                $('.summernote').summernote({
                    height: 400,
                    tabsize: 2
                });
            }

            return {
                // public functions
                init: function () {
                    demos();
                }
            };
        }();

        // Initialization
        jQuery(document).ready(function () {
            KTSummernoteDemo.init();
            $('.summernote').summernote('code', `@Html.Raw(ViewBag.partnerArticle.partner_content)`)
        });

        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    $('#avata').attr('src', e.target.result);
                }

                reader.readAsDataURL(input.files[0]);
            }
        }

        $("#imgInp").change(function () {
            readURL(this);
        });
    </script>

    <script>
        var rowIdx = 1;
        $('#partner_acitivity_table').DataTable({
            oLanguage: {
                oPaginate: {
                    sPrevious: "Trang trước",
                    sNext: "Trang sau"
                },
                sEmptyTable: "Không có dữ liệu",
                sInfo: "Đang hiển thị từ _START_ đến _END_ của _TOTAL_ bản ghi",
            },
            searching: false,
            lengthChange: false,
            ajax: {
                url: "@Url.Action("Detail_History", "Partner")",
                type: "POST",
                datatype: "json",
                data: { 'id': @ViewBag.partnerArticle.partner_id },
                cache: "false"
            },
            //order: [7, 'asc'],
            pageLength: 5,
            columns: [
                {
                    render: function (data, type, row, meta) {
                        return meta.row + meta.settings._iDisplayStart + 1;
                    }
                },
                { data: 'code', name: 'code'},
                { data: 'activity', name: 'activity'},
                { data: 'contact_point_name', name: 'contact_point_name'},
                { data: 'contact_point_email', name: 'contact_point_email'},
                { data: 'contact_point_phone', name: 'contact_point_phone'},
                { data: 'full_name', name: 'full_name'},
                {
                    data: 'activity_date_start',
                    name: 'activity_date_start',
                    render: function (data, type) {
                        if (type === "sort" || type === "") {
                            return data;
                        }
                        return moment(data).format("DD/MM/YYYY");
                    }
                },
                {
                    data: 'activity_date_end',
                    name: 'activity_date_end',
                    render: function (data, type) {
                        if (type === "sort" || type === "") {
                            return data;
                        }
                        return moment(data).format("DD/MM/YYYY");
                    }
                },
            ],
            columnDefs: [
                {
                    targets: '_all',
                    className: 'text-center'
                }
            ],
            initComplete: function () {
                $(this).parent().css('overflow-x', 'auto');
                //$(this).parent().css('padding', '0');
            }
        });
    </script>


}
